name: Deploy (Helm from OCI)

on:
    workflow_dispatch:
        inputs:
            chart_version:
                description: "Helm chart version to deploy"
                required: true
            namespace:
                description: "Kubernetes namespace"
                required: true
                default: "didcomm-chatbots"
            release_name:
                description: "Helm release name"
                required: true
                default: "verana-faucet-hologram"

permissions:
    contents: read

jobs:
    deploy:
        runs-on: ubuntu-latest
        env:
            IMAGE_REPO: ${{ secrets.DOCKER_HUB_LOGIN }}/verana-faucet-hologram-chatbot
            CHART_REF: oci://registry-1.docker.io/${{ secrets.DOCKER_HUB_LOGIN }}/verana-faucet-hologram-chatbot

        steps:
            - name: Set up kubectl
              uses: azure/setup-kubectl@v4
              with:
                  version: v1.29.9

            - name: Set up Helm
              uses: azure/setup-helm@v4

            - name: Configure kubeconfig
              shell: bash
              run: |
                  set -euo pipefail
                  echo "${{ secrets.OVH_KUBECONFIG_DEVNET }}" > /tmp/kubeconfig
                  echo "KUBECONFIG=/tmp/kubeconfig" >> "$GITHUB_ENV"

            - name: Helm registry login
              shell: bash
              run: |
                  set -euo pipefail
                  echo "${{ secrets.DOCKER_HUB_PWD }}" | helm registry login registry-1.docker.io \
                    -u "${{ secrets.DOCKER_HUB_LOGIN }}" --password-stdin

            - name: Deploy using published OCI chart
              shell: bash
              run: |
                  set -euo pipefail

                  CHART_VERSION="${{ inputs.chart_version }}"
                  IMAGE_TAG="v${CHART_VERSION}"

                  helm upgrade --install "${{ inputs.release_name }}" "${CHART_REF}" \
                    --version "${CHART_VERSION}" \
                    -n "${{ inputs.namespace }}" \
                    --create-namespace \
                    --wait --atomic --timeout 20m \
                    --set-string "postgres.secret.password=${{ secrets.POSTGRES_PASSWORD }}" \
                    --set-string "chatbotBackend.secret.QUARKUS_ARTEMIS_PASSWORD=${{ secrets.ARTEMIS_PASSWORD }}" \
                    --set-string "faucetApp.secret.FAUCET_MNEMONIC=${{ secrets.FAUCET_MNEMONIC }}" \
                    --set-string "stats.secret.QUARKUS_ARTEMIS_A0_PASSWORD=${{ secrets.ARTEMIS_PASSWORD }}" \
                    --set-string "stats.secret.QUARKUS_DATASOURCE_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}"

            - name: Cleanup kubeconfig
              if: always()
              run: rm -f /tmp/kubeconfig
