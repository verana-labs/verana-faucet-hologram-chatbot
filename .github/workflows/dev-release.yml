name: Dev release faucet chatbot

on:
  push:
    branches:
      - main
      - "release/**"

concurrency:
  group: dev-release-faucet-chatbot-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release-please:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Release Please
        id: rp
        uses: googleapis/release-please-action@v4
        with:
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json
          release-type: maven
          token: ${{ secrets.GITHUB_TOKEN }}

  dev-release:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      QUARKUS_CONTAINER_IMAGE_USERNAME: ${{ secrets.DOCKER_HUB_LOGIN }}
      QUARKUS_CONTAINER_IMAGE_PASSWORD: ${{ secrets.DOCKER_HUB_PWD }}
      IMAGE_NAME: verana-faucet-hologram-chatbot
      IMAGE_REPO: ${{ secrets.DOCKER_HUB_LOGIN }}/verana-faucet-hologram-chatbot
      K8S_NAMESPACE: didcomm-chatbots
      HELM_RELEASE: verana-faucet-hologram
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: temurin
          cache: maven

      - name: Resolve project version
        shell: bash
        run: |
          set -euo pipefail
          PROJECT_VERSION="$(./mvnw -q -DforceStdout help:evaluate -Dexpression=project.version)"
          BASE_VERSION="${PROJECT_VERSION%-SNAPSHOT}"

          IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE_VERSION"
          DEV_TAG="v${BASE_VERSION}-dev.${GITHUB_RUN_NUMBER}"

          echo "PROJECT_VERSION=$PROJECT_VERSION" >> "$GITHUB_ENV"
          echo "BASE_VERSION=$BASE_VERSION" >> "$GITHUB_ENV"
          echo "MAJOR=$MAJOR" >> "$GITHUB_ENV"
          echo "MINOR=$MINOR" >> "$GITHUB_ENV"
          echo "DEV_TAG=$DEV_TAG" >> "$GITHUB_ENV"

      - name: Build & push dev image (Quarkus)
        shell: bash
        run: |
          set -euo pipefail
          ./mvnw -B package -DskipTests \
            -Dquarkus.container-image.build=true \
            -Dquarkus.container-image.push=true \
            -Dquarkus.container-image.image="${IMAGE_REPO}" \
            -Dquarkus.container-image.tag=dev \
            -Dquarkus.container-image.additional-tags="v${MAJOR}-dev,v${MAJOR}.${MINOR}-dev,${DEV_TAG}"

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.29.9

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Configure kubeconfig
        shell: bash
        run: |
          set -euo pipefail
          echo "${{ secrets.OVH_KUBECONFIG_DEVNET }}" > /tmp/kubeconfig
          echo "KUBECONFIG=/tmp/kubeconfig" >> "$GITHUB_ENV"

      - name: Helm registry login
        shell: bash
        run: |
          set -euo pipefail
          echo "${{ secrets.DOCKER_HUB_PWD }}" | helm registry login registry-1.docker.io \
            -u "${{ secrets.DOCKER_HUB_LOGIN }}" --password-stdin

      - name: Build Helm dependencies
        run: helm dependency build ./charts

      - name: Lint Helm chart
        run: helm lint ./charts

      - name: Deploy with Helm
        shell: bash
        run: |
          set -euo pipefail
          helm upgrade --install "${HELM_RELEASE}" ./charts \
            -n "${K8S_NAMESPACE}" \
            --create-namespace \
            --wait \
            --atomic \
            --timeout 20m \
            --set "chatbotBackend.image.repository=${IMAGE_REPO}" \
            --set "chatbotBackend.image.tag=${DEV_TAG}" \
            --set "chatbotBackend.image.pullPolicy=Always" \
            --set-string "postgres.secret.password=${{ secrets.POSTGRES_PASSWORD }}" \
            --set-string "chatbotBackend.secret.QUARKUS_ARTEMIS_PASSWORD=${{ secrets.ARTEMIS_PASSWORD }}" \
            --set-string "faucetApp.secret.FAUCET_MNEMONIC=${{ secrets.FAUCET_MNEMONIC }}" \
            --set-string "stats.secret.QUARKUS_ARTEMIS_A0_PASSWORD=${{ secrets.ARTEMIS_PASSWORD }}" \
            --set-string "stats.secret.QUARKUS_DATASOURCE_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}"

      - name: Cleanup kubeconfig
        if: always()
        run: rm -f /tmp/kubeconfig
