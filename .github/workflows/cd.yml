name: Continuous Deployment

on:
  push:
    branches: [main, "release/**"]

permissions:
  id-token: write
  contents: write
  issues: write
  pull-requests: write

env:
  IMAGE_NAME: verana-faucet-hologram-chatbot

jobs:
  resolve-version:
    uses: 2060-io/organization/.github/workflows/resolve-version-call.yml@main

  docker:
    needs: resolve-version
    if: needs.resolve-version.outputs.new-release-published == 'true'
    runs-on: ubuntu-latest

    env:
      RELEASE_TYPE: ${{ needs.resolve-version.outputs.release-type }}
      RELEASE_VERSION: ${{ needs.resolve-version.outputs.release-version }}
      RELEASE_MAJOR: ${{ needs.resolve-version.outputs.release-major }}
      RELEASE_MINOR: ${{ needs.resolve-version.outputs.release-minor }}
      RELEASE_PATCH: ${{ needs.resolve-version.outputs.release-patch }}

      QUARKUS_CONTAINER_IMAGE_USERNAME: ${{ secrets.DOCKER_HUB_LOGIN }}
      QUARKUS_CONTAINER_IMAGE_PASSWORD: ${{ secrets.DOCKER_HUB_PWD }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute tags
        shell: bash
        run: |
          set -euo pipefail

          if [ "$RELEASE_TYPE" = "stable" ]; then
            echo "IMAGE_TAG=latest" >> "$GITHUB_ENV"
            echo "SUFFIX=" >> "$GITHUB_ENV"
          else
            echo "IMAGE_TAG=dev" >> "$GITHUB_ENV"
            echo "SUFFIX=-dev" >> "$GITHUB_ENV"
            echo "RELEASE_PATCH_SHORT=${RELEASE_PATCH:0:1}" >> "$GITHUB_ENV"
          fi

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: temurin
          cache: maven

      - name: Build & push ${{ env.IMAGE_NAME }} dev tags (Quarkus)
        if: env.RELEASE_TYPE == 'dev'
        shell: bash
        run: |
          set -euo pipefail

          ./mvnw -B package -DskipTests \
            -Dquarkus.container-image.build=true \
            -Dquarkus.container-image.push=true \
            -Dquarkus.container-image.image="${{ secrets.DOCKER_HUB_LOGIN }}/${IMAGE_NAME}" \
            -Dquarkus.container-image.tag="${IMAGE_TAG}" \
            -Dquarkus.container-image.additional-tags="v${RELEASE_MAJOR}${SUFFIX},v${RELEASE_MAJOR}.${RELEASE_MINOR}${SUFFIX},v${RELEASE_MAJOR}.${RELEASE_MINOR}.${RELEASE_PATCH_SHORT}${SUFFIX},${RELEASE_VERSION}"

      - name: Build & push ${{ env.IMAGE_NAME }} stable release tags (Quarkus)
        if: env.RELEASE_TYPE == 'stable'
        shell: bash
        run: |
          set -euo pipefail

          ./mvnw -B package -DskipTests \
            -Dquarkus.container-image.build=true \
            -Dquarkus.container-image.push=true \
            -Dquarkus.container-image.image="${{ secrets.DOCKER_HUB_LOGIN }}/${IMAGE_NAME}" \
            -Dquarkus.container-image.tag="${IMAGE_TAG}" \
            -Dquarkus.container-image.additional-tags="v${RELEASE_MAJOR}${SUFFIX},v${RELEASE_MAJOR}.${RELEASE_MINOR}${SUFFIX},${RELEASE_VERSION}"

  helm:
    needs: [resolve-version, docker]
    if: needs.resolve-version.outputs.new-release-published == 'true'
    runs-on: ubuntu-latest
    env:
      RELEASE_TYPE: ${{ needs.resolve-version.outputs.release-type }}
      RELEASE_VERSION: ${{ needs.resolve-version.outputs.release-version }}
      RELEASE_MAJOR: ${{ needs.resolve-version.outputs.release-major }}
      RELEASE_MINOR: ${{ needs.resolve-version.outputs.release-minor }}
      RELEASE_PATCH: ${{ needs.resolve-version.outputs.release-patch }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Docker login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_LOGIN }}
          password: ${{ secrets.DOCKER_HUB_PWD }}

      - name: Push Helm chart to Docker Hub OCI repo
        shell: bash
        run: |
          set -euo pipefail

          # Helm chart version must be semver WITHOUT leading 'v'
          VERSION_NO_V="${RELEASE_VERSION#v}"

          if [ "$RELEASE_TYPE" = "stable" ]; then
            TAGS=("${VERSION_NO_V}")
          else
            TAGS=(
              "${RELEASE_MAJOR}.${RELEASE_MINOR}.${RELEASE_PATCH:0:1}-dev"
              "${VERSION_NO_V}"
            )
          fi

          CHART_NAME=$(grep '^name:' ./charts/Chart.yaml | awk '{print $2}')

          for tag in "${TAGS[@]}"; do
            sed -i "s/^version:.*/version: ${tag}/" ./charts/Chart.yaml
            helm dependency update ./charts
            helm package ./charts --version $tag -d ./charts
            helm push "./charts/${CHART_NAME}-${tag}.tgz" "oci://docker.io/${{ secrets.DOCKER_HUB_LOGIN }}"
          done
