name: Continuous Integration

on:
    pull_request:
        branches: [main, "release/**"]
    push:
        branches: [main, "release/**"]

concurrency:
    group: lint-${{ github.ref }}
    cancel-in-progress: true

permissions:
    contents: read

jobs:
    lint:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set up JDK 17
              uses: actions/setup-java@v4
              with:
                  java-version: 17
                  distribution: temurin
                  cache: maven

            - name: Maven compile
              run: |
                  set -euo pipefail
                  ./mvnw -B -DskipTests compile

            - name: Set up Helm
              uses: azure/setup-helm@v4

            - name: Helm dependency build (best effort)
              shell: bash
              run: |
                  set -euo pipefail
                  if [ -f ./charts/Chart.yaml ]; then
                    helm dependency build ./charts || true
                  fi

            - name: Helm lint
              run: |
                  set -euo pipefail
                  helm lint ./charts
